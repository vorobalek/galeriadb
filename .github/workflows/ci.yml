name: CI

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  gate:
    name: Skip gate
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - id: check
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          # Manual runs are never blocked
          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          last_commit_msg="$(git log -1 --pretty=%B 2>/dev/null || true)"

          haystack="${PR_TITLE:-}
          ${PR_BODY:-}
          ${last_commit_msg}"

                    if echo "$haystack" | grep -Fq "[skip-ci]"; then
                      echo "skip=true" >> "$GITHUB_OUTPUT"
                    else
                      echo "skip=false" >> "$GITHUB_OUTPUT"
                    fi

  ci:
    name: CI (make ci)
    runs-on: ubuntu-latest
    needs: gate
    if: github.event_name == 'workflow_dispatch' || needs.gate.outputs.skip != 'true'
    env:
      # Test tag: commit SHA only (no latest). Publish workflow uses its own tag.
      IMAGE: galeriadb/11.8:sha-${{ github.sha }}
      ARTIFACTS_DIR: ${{ github.workspace }}/artifacts
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build dev image
        run: docker build -t galeriadb/dev:ci -f docker/Dockerfile.dev .

      - name: Cache Trivy vulnerability DB
        uses: actions/cache@v5
        with:
          path: .cache/trivy
          key: trivy-db-${{ runner.os }}
          restore-keys: trivy-db-

      - name: Run all tests
        run: |
          mkdir -p .cache/trivy
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${{ github.workspace }}/.cache/trivy:/root/.cache/trivy" \
            -w /workspace \
            -e IMAGE="${{ env.IMAGE }}" \
            -e ARTIFACTS_DIR="${{ env.ARTIFACTS_DIR }}" \
            -e HOST_WORKSPACE="${{ github.workspace }}" \
            galeriadb/dev:ci \
            make ci

      - name: Fix Trivy cache permissions for cache save
        if: success() || failure()
        run: sudo chown -R "$(id -u):$(id -g)" .cache/trivy 2>/dev/null || true

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          mkdir -p "${{ env.ARTIFACTS_DIR }}"
          docker ps -a > "${{ env.ARTIFACTS_DIR }}/docker-ps.txt" 2>&1 || true
          docker network ls > "${{ env.ARTIFACTS_DIR }}/docker-network-ls.txt" 2>&1 || true
          docker volume ls > "${{ env.ARTIFACTS_DIR }}/docker-volume-ls.txt" 2>&1 || true
          docker compose -f tests/02.deploy/compose/compose.test.yml -p galeriadb-test logs --no-color > "${{ env.ARTIFACTS_DIR }}/compose-logs.txt" 2>&1 || true
          for cid in $(docker compose -f tests/02.deploy/compose/compose.test.yml -p galeriadb-test ps -aq 2>/dev/null || true); do
            [ -z "$cid" ] && continue
            name=$(docker inspect -f '{{.Name}}' "$cid" 2>/dev/null | tr -d '/')
            docker inspect "$cid" > "${{ env.ARTIFACTS_DIR }}/inspect-$name.json" 2>&1 || true
          done

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ci-diagnostics
          path: ${{ env.ARTIFACTS_DIR }}
          if-no-files-found: ignore

  swarm:
    name: Swarm (make swarm)
    runs-on: ubuntu-latest
    needs: [gate, ci]
    if: github.event_name == 'workflow_dispatch' || needs.gate.outputs.skip != 'true'
    env:
      IMAGE: galeriadb/11.8:sha-${{ github.sha }}
    steps:
      - uses: actions/checkout@v6

      - name: Run swarm sanity
        run: make swarm
