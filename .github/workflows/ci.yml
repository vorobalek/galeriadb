name: CI

on:
  pull_request:
    branches: [main, "11.8"]
  workflow_dispatch:

jobs:
  gate:
    name: Skip gate
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}

      - id: check
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          # Manual runs are never blocked
          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          last_commit_msg="$(git log -1 --pretty=%B 2>/dev/null || true)"

          haystack="${PR_TITLE:-}
          ${PR_BODY:-}
          ${last_commit_msg}"

                    if echo "$haystack" | grep -Fq "[skip-ci]"; then
                      echo "skip=true" >> "$GITHUB_OUTPUT"
                    else
                      echo "skip=false" >> "$GITHUB_OUTPUT"
                    fi

  ci:
    name: CI (make ci)
    runs-on: ubuntu-latest
    needs: gate
    if: github.event_name == 'workflow_dispatch' || needs.gate.outputs.skip != 'true'
    env:
      # Test tag: commit SHA only (no latest). Publish workflow uses its own tag.
      IMAGE: galeriadb/12.1:sha-${{ github.sha }}
      ARTIFACTS_DIR: ${{ github.workspace }}/artifacts
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker daemon (disable containerd image store)
        uses: docker/setup-docker-action@v4
        with:
          daemon-config: |
            {
              "features": {
                "containerd-snapshotter": false
              }
            }

      - name: Show Docker info
        run: |
          docker version
          docker info

      - name: Run all tests
        run: make ci-docker

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          mkdir -p "${{ env.ARTIFACTS_DIR }}"
          {
            echo "=== host: docker version ==="
            docker version
            echo
            echo "=== host: docker info ==="
            docker info
            echo
            echo "=== host: disk usage ==="
            df -h
            echo
            echo "=== host: /tmp disk usage ==="
            df -h /tmp
          } > "${{ env.ARTIFACTS_DIR }}/host-env.txt" 2>&1 || true

          docker image inspect "${{ env.IMAGE }}" > "${{ env.ARTIFACTS_DIR }}/image-inspect.json" 2>&1 || true

          # Reproduce Trivy context in the same dev image used by make ci-docker.
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -w /workspace \
            -e IMAGE="${{ env.IMAGE }}" \
            -e ARTIFACTS_DIR="/workspace/artifacts" \
            galeriadb/dev:local \
            bash -lc '
              set -u
              mkdir -p "$ARTIFACTS_DIR"

              {
                echo "=== dev-container: trivy version ==="
                trivy --version
                echo
                echo "=== dev-container: docker version ==="
                docker version
                echo
                echo "=== dev-container: docker info ==="
                docker info
                echo
                echo "=== dev-container: disk usage ==="
                df -h
                echo
                echo "=== dev-container: /tmp disk usage ==="
                df -h /tmp
              } > "$ARTIFACTS_DIR/trivy-env.txt" 2>&1 || true

              docker save "$IMAGE" -o /tmp/trivy-image.tar 2>"$ARTIFACTS_DIR/docker-save.stderr" || true
              ls -lh /tmp/trivy-image.tar > "$ARTIFACTS_DIR/docker-save-size.txt" 2>&1 || true
              tar -tf /tmp/trivy-image.tar > "$ARTIFACTS_DIR/docker-save-tar-list.txt" 2>&1 || true
              tar -xOf /tmp/trivy-image.tar manifest.json > "$ARTIFACTS_DIR/docker-save-manifest.json" 2>/dev/null || true

              cfg="$(grep -oE "\"Config\"[[:space:]]*:[[:space:]]*\"[^\"]+\"" "$ARTIFACTS_DIR/docker-save-manifest.json" | head -n1 | sed -E "s/.*\"([^\"]+)\"$/\\1/")"
              {
                echo "manifest_config=$cfg"
                if [ -n "$cfg" ]; then
                  if tar -tf /tmp/trivy-image.tar | grep -Fxq "$cfg"; then
                    echo "config_path_present=yes"
                  elif tar -tf /tmp/trivy-image.tar | grep -Fxq "./$cfg"; then
                    echo "config_path_present=only_with_dot_slash"
                  else
                    echo "config_path_present=no"
                  fi
                fi
              } > "$ARTIFACTS_DIR/docker-save-manifest-check.txt" 2>&1 || true

              TRIVY_DEBUG=true trivy image --scanners vuln "$IMAGE" > "$ARTIFACTS_DIR/trivy-debug.log" 2>&1 || true
              rm -f /tmp/trivy-image.tar
            ' || true

          docker ps -a > "${{ env.ARTIFACTS_DIR }}/docker-ps.txt" 2>&1 || true
          docker network ls > "${{ env.ARTIFACTS_DIR }}/docker-network-ls.txt" 2>&1 || true
          docker volume ls > "${{ env.ARTIFACTS_DIR }}/docker-volume-ls.txt" 2>&1 || true
          docker compose -f tests/02.deploy/compose/compose.test.yml -p galeriadb-test logs --no-color > "${{ env.ARTIFACTS_DIR }}/compose-logs.txt" 2>&1 || true
          for cid in $(docker compose -f tests/02.deploy/compose/compose.test.yml -p galeriadb-test ps -aq 2>/dev/null || true); do
            [ -z "$cid" ] && continue
            name=$(docker inspect -f '{{.Name}}' "$cid" 2>/dev/null | tr -d '/')
            docker inspect "$cid" > "${{ env.ARTIFACTS_DIR }}/inspect-$name.json" 2>&1 || true
          done

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ci-diagnostics
          path: ${{ env.ARTIFACTS_DIR }}
          if-no-files-found: ignore

  swarm:
    name: Swarm (make swarm)
    runs-on: ubuntu-latest
    needs: [gate, ci]
    if: github.event_name == 'workflow_dispatch' || needs.gate.outputs.skip != 'true'
    env:
      IMAGE: galeriadb/12.1:sha-${{ github.sha }}
    steps:
      - uses: actions/checkout@v6

      - name: Run swarm sanity
        run: make swarm
