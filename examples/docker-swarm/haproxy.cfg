# HAProxy for MariaDB Galera Cluster (Swarm)
# Routes traffic only to nodes that are Synced (ready for writes).
# Uses resolvers + init-addr none so backends are re-resolved after task restarts.

global
    maxconn 4096
    log stdout format raw local0

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5s
    timeout client 50s
    timeout server 50s

listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /metrics

resolvers hostdns
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 5s
    hold nx 2s

listen galera-write
    bind *:3306
    mode tcp
    balance roundrobin
    option mysql-check user root
    option httpchk
    http-check connect port 9200
    http-check send meth GET uri /
    http-check expect status 200
    timeout check 10s
    default-server init-addr none resolvers hostdns inter 3s fall 2 rise 2 on-marked-down shutdown-sessions
    server galera-node-a galera-node-a:3306 check port 9200
    server galera-node-b galera-node-b:3306 check port 9200
    server galera-node-c galera-node-c:3306 check port 9200
