# MariaDB Galera Cluster + HAProxy â€” Docker Swarm stack example
# Deploy: docker stack deploy -c docker-compose.yml mariadb (from dir with stack.env).
# Requires: stack.env (copy from stack.env.example), HAProxy config at volume path,
# Galera data dirs (or adjust volume path). Node hostnames: node-a, node-b, node-c.

networks:
  internal-mariadb-lan:
    driver: overlay

services:
  hamariadb:
    image: haproxy:latest
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        reservations:
          memory: 128M
        limits:
          memory: 512M
      update_config:
        order: stop-first
        parallelism: 1
        failure_action: rollback
    ports:
      - "3306:3306"
      - "7000:7000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - /data/shared/mariadb/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - internal-mariadb-lan

  galera:
    image: ${IMAGE:-galeriadb/12.1:latest}
    hostname: galera-{{.Node.Hostname}}
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 5s
      resources:
        reservations:
          memory: 2048M
        limits:
          memory: 4096M
      update_config:
        order: stop-first
        parallelism: 1
        failure_action: rollback
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    env_file:
      - stack.env
    healthcheck:
      test: ["CMD-SHELL", "mariadb -u root -p$$GALERIA_ROOT_PASSWORD -e \"SHOW STATUS LIKE 'wsrep_local_state_comment';\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    volumes:
      - /data/mariadb/{{.Node.Hostname}}:/var/lib/mysql:rw
    networks:
      - internal-mariadb-lan

  mariadb-exporter:
    image: prom/mysqld-exporter:latest
    hostname: mariadb-exporter-{{.Node.Hostname}}
    entrypoint: ["sh", "-c"]
    command:
      - 'exec mysqld_exporter --mysqld.address=$$MYSQLD_ADDRESS --mysqld.username=monitoring'
    environment:
      MYSQLD_ADDRESS: 'galera-{{.Node.Hostname}}:3306'
    env_file:
      - stack.env
    deploy:
      mode: global
      resources:
        reservations:
          memory: 128M
        limits:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
      update_config:
        order: stop-first
        parallelism: 1
        failure_action: rollback
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "9090:9090"
    networks:
      - internal-mariadb-lan
