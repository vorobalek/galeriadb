# HAProxy for MariaDB Galera Cluster
# Routes traffic only to nodes that are Synced (ready for writes).
# Client connects to 3306 as to a single MariaDB.

global
    maxconn 4096
    log stdout format raw local0

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s

# Health check: HTTP on port 9200; 200 = node ready for writes
listen galera-write
    bind *:3306
    mode tcp
    balance roundrobin
    option mysql-check user root
    # Custom check: only use nodes that return 200 on port 9200 (wsrep_ready=ON, Synced)
    option httpchk
    http-check connect port 9200
    http-check send meth GET uri /
    http-check expect status 200
    timeout check 10s
    default-server inter 3s fall 2 rise 2 on-marked-down shutdown-sessions
    server galera1 galera1:3306 check port 9200
    server galera2 galera2:3306 check port 9200
    server galera3 galera3:3306 check port 9200
