# MariaDB Galera Cluster + HAProxy â€” example stack for testing
# Connect to cluster: haproxy:3306 (single endpoint; HAProxy routes only to Synced nodes)
# Image: galeriadb/10.11:latest (see README)

services:
  galera1:
    image: galeriadb/10.11:latest
    hostname: galera1
    environment:
      MYSQL_ROOT_PASSWORD: secret
      GALERA_PEERS: galera1,galera2,galera3
      WSREP_CLUSTER_NAME: galera_cluster
    volumes:
      - galera1_data:/var/lib/mysql
    networks:
      galera_net:
        aliases:
          - galera1
    healthcheck:
      test: ["CMD", "mariadb", "-u", "root", "-psecret", "-e", "SHOW STATUS LIKE 'wsrep_local_state_comment';"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  galera2:
    image: galeriadb/10.11:latest
    hostname: galera2
    environment:
      MYSQL_ROOT_PASSWORD: secret
      GALERA_PEERS: galera1,galera2,galera3
      WSREP_CLUSTER_NAME: galera_cluster
    volumes:
      - galera2_data:/var/lib/mysql
    networks:
      galera_net:
        aliases:
          - galera2
    healthcheck:
      test: ["CMD", "mariadb", "-u", "root", "-psecret", "-e", "SHOW STATUS LIKE 'wsrep_local_state_comment';"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  galera3:
    image: galeriadb/10.11:latest
    hostname: galera3
    environment:
      MYSQL_ROOT_PASSWORD: secret
      GALERA_PEERS: galera1,galera2,galera3
      WSREP_CLUSTER_NAME: galera_cluster
    volumes:
      - galera3_data:/var/lib/mysql
    networks:
      galera_net:
        aliases:
          - galera3
    healthcheck:
      test: ["CMD", "mariadb", "-u", "root", "-psecret", "-e", "SHOW STATUS LIKE 'wsrep_local_state_comment';"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  haproxy:
    image: haproxy:2.9-alpine
    ports:
      - "3306:3306"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - galera_net

networks:
  galera_net:
    driver: bridge

volumes:
  galera1_data:
  galera2_data:
  galera3_data:
